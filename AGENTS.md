# Repository Guidelines

## プロジェクト構成とモジュール編成
本 リポジトリ は JR-100 向け DSL ツールチェーン を 開発 する ため の 単一 モノリポ として 設計 されています。`cli/` は CLI エントリーポイント を 提供 し、`asm/` は 字句 解析 から 符号化 まで の コア アセンブラ を 担当 します。リンク と 梱包 は `link/` と `proj/` に 分かれ、`std/` には VRAM 初期化 や キーボード 入力 など の 標準 マクロ を 配置 します。命令 抽出 や 逆アセンブル 確認 の ツール は `tools/` に まとめ、`samples/` と `tests/` が 最小 サンプル と 網羅 的 テスト の 集合 を 持ちます。自動 生成 物 で ある `asm/opcodes_mb8861h.py` と `docs/isa_mb8861h.md` は 手動 で 編集 せず、同期 スクリプト に 任せて ください。

## ビルド・テスト・開発コマンド
`jr100dev assemble src/main.asm -o build/main.prg` は DSL ソース を 機械語 と `.prg` に 変換 します。`jr100dev link build/*.o -o build/game.prg` は 再配置 オブジェクト を 結合 し、`python -m jr100emu.app --rom datas/jr100rom.prg --load build/game.prg` で エミュレーター を 起動 します。統合 テスト は `pytest tests`、命令 同期 は `python tools/sync_opcodes.py`、往復 検証 は `python tools/disasm_check.py` を 実行 してください。

## コーディングスタイルと命名規約
Python コード は PEP 8 と 4 スペース インデント を 基本 とし、型 ヒント と dataclass を 積極 的 に 活用 します。モジュール 名 は 小文字 スネーク、クラス 名 は パスカル ケース、列挙 や 定数 は 全部 大文字 スネーク を 用います。DSL ニーモニック は 大文字、ラベル は 大文字 先頭 スネーク、マクロ 名 は パスカル で 統一 します。`black` と `ruff` で 自動 整形 と 静的 解析 を 行い、生成 物 とは 別 に 管理 してください。

## アセンブリ実装上の注意
JR-100 の CPU は MB8861H（6802 相当）です。MC6809 命令は使用禁止で、6800 系標準命令と MB8861H 独自拡張（NIM/OIM/XIM/TMM/ADX/EXT）のみ利用します。命令セットを誤るとエミュレーター・実機双方で暴走するため、レビュー時も命令コードを必ず照合してください。

## テスト方針
単体 テスト は `tests/unit`、命令 網羅 ケース は `tests/opcodes`、統合 シナリオ は `tests/integ` に 追加 します。テスト ファイル 名 と 関数 名 は `test_*` で 始め、必要 に 応じて `@pytest.mark.parametrize` を 用いて 境界 条件 を 列挙 します。新規 命令 や アドレッシング を 追加 する 場合 は エミュレーター の 期待 レジスタ と CCR フラグ を 100% 覆う ケース を 用意 し、`clock_hz = 894000` を 参照 する サイクル 計測 も 更新 します。

## コミット と プルリクエスト
コミット メッセージ は 先頭 に `feat:`, `fix:`, `docs:`, `test:` など の 英語 動詞 ラベル を 付け、現在形 の 要約 を 続けます。本文 では 変更 理由 と 影響 範囲 を 箇条書き し、関連 Issue を `Refs #` 形式 で 記載 します。プルリクエスト では 目的、検証 手順、生成 物 の 影響 を 明示 し、ビルド ログ や エミュレーター の スクリーンショット を 必要 に 応じて 添付 してください。自動 生成 ファイル が 差分 に 含まれる 場合 は 同期 コマンド の 実行 日時 を 説明 に 加え、レビュワー が 再現 できる 状態 を 保ち ます。
