# MAZE2 開発メモ

## 目的
- `maze` サンプルをベースに、1 タイル = 3×3 文字に拡張したアクション寄りの迷路ゲームを実装する。
- 敵・アイテム・弾丸・タイマーなどの追加要素を扱えるよう、データ構造と描画パイプラインを再設計する。
- 元の MAZE の挙動やノウハウを活かしつつ、再ビルド漏れ・VRAM 文字コード変換忘れなど過去のミスを繰り返さない。

## 現状まとめ
- `samples/maze2` は `samples/maze` をベースに複製し、3×3 タイル描画を実装済み。
  * `MAZE_RENDER_VIEW` が各タイルを 3×3 文字に展開する。
  * `MAZE_SCROLL_TO_PLAYER` や `MAZE_UPDATE_PLAYER_DRAW` はタイル単位でスクロール・位置計算を行い、中央キャラクタ位置を算出する。
  * 迷路内部データ（セル探索・生成）は従来と同じ構造を流用している。
- データ構造を拡張し、以下を確保済み。
  * `ITEM_POSITIONS` / `ITEM_COLLECTED`（5 個固定）
  * `ENEMY_*`（最大 4 体分の座標・向き・回転ディレイ）
  * `BULLET_*`（単発弾）
  * `TIME_REMAIN_*`（180 秒カウントダウン用 BCD）
  * `PLAYER_SCREEN_TILE_*`（描画用タイル座標キャッシュ）
- Makefile は `common.inc` と `maze_helpers.inc` 変更時に再アセンブルされるよう依存関係を追加済み。`samples/maze2` で作業する場合でも `make clean`→`make build/maze.prg` を徹底すること。

## 次の実装項目
1. **ゲームループ拡張（フェーズ 3 計画）**
   - 敵 AI: 直前進行方向を保持し、左／右の 90° 回転を挟んで方向転換する挙動にする。
   - 弾丸: `BULLET_ACTIVE` が `1` の間は再発射不可。壁 or 画面端で停止 → 非アクティブ化。
   - ステージクリア条件: アイテム 5 個回収でクリア → 次レベルへ遷移（ハードを超えたらタイトルへ戻す等）。
2. **表示オーバーレイ**
   - 敵は専用文字（暫定 `E` など）を 3×3 の中央に描画。
   - 弾丸はタイル境界でも表示できるよう、キャラクタ座標を直接算出する（横移動時は中央列、縦移動時は中央行に配置）。
   - HUD にはタイマー（`TIME:xxxx`）と残りアイテム数（`ITEM:x`）を表示済み。ステップ数と同居するレイアウトを維持する。
3. **ヒット判定とゲームオーバー**
   - プレイヤーと敵／弾丸の衝突判定（タイル単位）。
   - 弾丸と敵の衝突判定 → 敵を一旦消滅させ、一定時間後にリスポーンさせるか、ステージ内の敵数を減らす方針を決める。

## テスト方針
- `samples/maze/tests` の `run_debug_checks.py` を流用／拡張し、MAZE2 用の追加テストスクリプトを作成する。
  * 3×3 タイル描画の妥当性: VRAM ダンプで壁・通路パターンを確認。
  * スクロール: タイルオリジンの変化をチェック（特にハードレベル）。
  * アイテム配置の初期化結果を RAM ダンプで確認。
- 敵・弾丸ロジック実装後は、pyjr100emu の debug_runner でシミュレーション時間を長めに取り挙動を検証する。

## 注意事項
- 共有定数 `common.inc` を変更した際は必ず `make clean && make build/maze.prg` を実行し、再ビルド漏れを防ぐ。
- VRAM へ文字を書き込む際は `__STD_TO_VRAM` を通すか、空白は `$40` を直接使用する。ASCII `' '` のままでは表示されない。
- RAM 使用上限は `$0300-$3FFF`。新規ワーク領域を追加する際は `maze_data.asm` の配置順とサイズを確認し、必要に応じて構造体を圧縮する。
- 3×3 ブロック描画はループで処理しているため、追加のオーバーレイ描画（敵・アイテム）も既存ヘルパーを流用し、コード重複を避ける。

本メモはフェーズ 3 以降の実装・レビュー時に随時更新する。
