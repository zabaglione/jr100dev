# JR-100 `.prg` 梱包仕様メモ

## 目的
JR-100 向けの簡易アセンブリ DSL から生成したバイナリを、`pyjr100emu` で読み込める `.prg` 形式に梱包するための前提情報を整理する。

## 調査済み事項
- `pyjr100emu` のローダは「PROG コンテナ」（Java 実装由来）を読み込む。先頭 4 バイトは `PROG` 固定で、続く 4 バイトはバージョン番号（1 or 2）。
- バージョン 2 はセクション（PNAM / PBAS / PBIN / CMNT ...）の繰り返しで構成される。`jr100dev` では以下のみを利用する。
  - `PNAM`: 先頭に UTF-8 文字列長（`uint32`）、続けてプログラム名。
  - `PBIN`: `uint32` の開始アドレス、`uint32` のバイナリ長、バイナリ本体、そしてコメント長 + コメント（UTF-8）。複数セクション可。
  - `CMNT`: 任意の全体コメント。
- BASIC プログラム領域（PBAS）はローダが BASIC ワークスペースの終端処理（`_finalize_basic`）を実行する。バイナリの場合は対象範囲にメモリを書き込むだけ。
- `pack_prg` はリンク結果のセグメントを複数 PBIN として出力し、先頭 PBIN のコメント欄に `entry=$XXXX` を記録する。プログラム名は CLI から指定でき、既定はソースファイル名を大文字化したもの。

## 未確定事項
- 複数 PBIN セクション使用時の連結順序ルール。
- エントリポイントを公式ツールがどこで管理しているか（コメント以外の保持場所の有無）。
- BASIC 領域（PBAS）とバイナリを同梱するユースケースのテンプレート。

## 次ステップ
1. 複数 PBIN セクション／PBAS 併用ケースを生成し、ローダ側挙動を確認。
2. セグメント分割した `.prg` を対象にした自動ロードスモークテストを追加。
3. プログラムコメントへビルドメタデータ（タイムスタンプ等）を埋め込む運用を検討。

## 参考リンク
- [pyjr100emu リポジトリ (要調査)](https://github.com/) `※` 正確な URL を確認して追記する。
- 実機取扱説明書・サービスマニュアル `※` 入手後に参照箇所を更新する。
