# JR-100 迷路ゲーム設計メモ（壁伸ばし法）

## 目標仕様
- マップサイズ: 4 画面分 (32×24 文字 ×4) → 128×96 文字。
- スタート: 左下隅、ゴール: 右上隅。
- 迷路生成: 壁伸ばし法（Growing Tree Algorithm の一種）。外枠は壁で固定。
- メモリ制約: RAM 16 KB を考慮し、迷路データはビット圧縮で保持。

## 表現方式
- 1 セル = 2×2 文字ブロック（壁/通路）。セル数は 64×48。
- 1 セルにつき 4 方角の壁状態を 4 bit で管理 (`NESW` 順)。
- データ構造: `maze_cells = VARZ MAZE_CELLS, 64*48`.  
  - 各要素 1 バイト: 上位 4 bit は壁フラグ、下位 4 bit は訪問フラグ + 予備。
  - 壁ビット: `N=0x8, E=0x4, S=0x2, W=0x1`。開通するとビットをクリア。
- VRAM 描画用: 1 セル -> 2×2 文字を描画 (壁は `#`, 通路は `' '`、プレイヤーは別置換)。
- 外枠: 初期化時に壁ビットを立てたまま固定。ゴールセルだけ外へ通路を開ける。

## 迷路生成 (壁伸ばし法)
1. セルスタック `stack` を確保 (`VARZ MAZE_STACK, 64*48`); スタックポインタ `stack_pos`。
2. 任意セル (例: ゴール) を訪問済みにし、スタックへ push。
3. ループ:
   - スタックからランダムに 1 セル選択 (LIFO でも良いが壁伸ばし法なのでランダムインデックス)。
   - 未訪問の隣接セルを列挙。1 つでもあればランダム選択し、双方の壁ビットをクリアして新セルを訪問済みにし、スタックへ push。
   - 未訪問隣接セルが無ければスタックからこのセルを pop。
4. スタックが空になれば終了。
- ゴール/スタート周辺は通路を確保しておく（最終的に確実に開通）。

## PRNG
- 線形合同法: `seed = (seed * 109 + 211) mod 256`。8bit で完結。
- 迷路用シード: `VAR8 RNG_SEED, $5A`。  
  - `random_byte`: `LDA RNG_SEED`, `MUL` の代わりに `(seed * 109)` は `seed*64 + seed*32 + seed*8 + seed*4 + seed + seed` で組む（コスト大）。  
  - より簡便に `seed = (seed * 5 + 1) mod 256` → 乗算は `LSL` と `ADD` で実現可能。
- 方向ランダムは `random_byte % count` で選択するが、除算を避けるためビットマスク＋バイアス (while) で実装。

## メモリ割り当て
- `MAZE_CELLS` (3072 bytes)
- `MAZE_STACK` (3072 bytes)
- 余り: 約 6 KB でプレイヤー座標、スクロール情報等に使用。

## 次ステップ
1. 迷路生成ルーチン (`maze_generate`) の実装。
2. VRAM 描画ルーチン (`maze_draw`) を追加し、4 画面スクロールとのインタフェースを決める。
