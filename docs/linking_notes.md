# リンク処理メモ（MVP）

## 目的
`assemble` が生成する JSON オブジェクト（`jr100dev-object`）を複数受け取り、重複がないことを確認した上で 1 本のバイナリおよび `.prg` を作成する。

## 前提
- 各オブジェクトは `sections[*].address` で絶対アドレスを指定している。
- `relocations` は `absolute16` / `absolute8` / `relative8` をサポートし、リンク時に値を書き戻す。
- 全オブジェクトの `entry_point` は一致している前提。CLI で上書き指定も可能にする（未指定時は先頭オブジェクト）。

## アルゴリズム
1. JSON を読み込み、`sections[*].content` をバイト列へ復元する（16進表記想定）。
2. 全セクションをアドレス順に整列し、オーバーラップが無いかチェックする。
3. 最小アドレスを `origin`、最大アドレス＋長さを `end_address` として `bytearray` を確保し、欠けている区間は `0x00` でパディングする。
4. セクションデータを `image[offset:offset+len]` に書き込み、`bss` セクションは長さ分だけゼロで埋める（ギャップはそのままゼロ）。
5. 重複アドレスを検出したら即エラーにする。
6. シンボルテーブルを統合し、重複名は同一値のみ許可。それ以外はエラー。
7. 再配置テーブルを走査し、対象シンボルの値を書き戻す（`absolute16/8` は直接書き込み、`relative8` はリンク後の分岐差分を算出する）。
8. CLI で `.bin` と `.prg` を出力し、`.map` が指定されていれば統合シンボルを出力する。
9. `.prg` はリンク結果のセクション境界ごとに PBIN セグメントを分割し、ギャップを含めずに配置する（BSS はゼロ埋めしたセグメントとして書き出す）。

## エラー条件
- 未知フォーマット／バージョン。
- セクションが重複、または 64KiB を越える場合。
- シンボル名が同一で値が異なる場合。
- オブジェクトが 1 つも指定されない場合。

## 次ステップ
- `.prg` パッカー側でセクションベースの情報を保持し、ロードアドレスと一致するかを検証する。
- 分岐境界（±128）やページ跨ぎケースを追加テストでカバーする。
- さらなる再配置形式（例えば `relative16` 等）の検討。

## CLI オプション
- `--text-base`, `--data-base`, `--bss-base` を指定すると、それぞれのセクションの開始アドレスを上書きしてリンク時に再配置する。
- 指定が無い場合はオブジェクト内の最小アドレスが利用される。
- `link` サブコマンドは `.prg` 生成時にセグメント情報を使用し、各セクションを個別の PBIN として梱包する。
